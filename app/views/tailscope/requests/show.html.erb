<div class="mb-4">
  <a href="<%= tailscope.requests_path %>" class="text-sm text-blue-600 hover:underline">&larr; Back to requests</a>
</div>

<h1 class="text-2xl font-bold mb-6">Request #<%= @request_record["id"] %></h1>

<div class="bg-white rounded-lg shadow p-6 space-y-4">
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div>
      <div class="text-sm text-gray-500">Method</div>
      <div class="font-mono font-semibold"><%= @request_record["method"] %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Path</div>
      <div class="font-mono text-sm"><%= @request_record["path"] %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Status</div>
      <div><%= @request_record["status"] %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Duration</div>
      <div><%= duration_badge(@request_record["duration_ms"]) %></div>
    </div>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div>
      <div class="text-sm text-gray-500">Controller</div>
      <div class="text-sm"><%= @request_record["controller"] || "—" %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Action</div>
      <div class="text-sm"><%= @request_record["action"] || "—" %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">View Runtime</div>
      <div><%= @request_record["view_runtime_ms"] ? duration_badge(@request_record["view_runtime_ms"]) : "—" %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">DB Runtime</div>
      <div><%= @request_record["db_runtime_ms"] ? duration_badge(@request_record["db_runtime_ms"]) : "—" %></div>
    </div>
  </div>

  <% if @request_record["params"].present? %>
    <div>
      <div class="text-sm text-gray-500 mb-1">Params</div>
      <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"><code><%= @request_record["params"] %></code></pre>
    </div>
  <% end %>

  <div class="grid grid-cols-2 gap-4">
    <div>
      <div class="text-sm text-gray-500">Request ID</div>
      <div class="text-sm font-mono"><%= @request_record["request_id"] || "—" %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Recorded</div>
      <div class="text-sm"><%= @request_record["recorded_at"] %></div>
    </div>
  </div>
</div>

<% if @queries.any? %>
  <h2 class="text-xl font-bold mt-8 mb-4">Queries (<%= @queries.size %>)</h2>

  <% n_plus_one_queries = @queries.select { |q| q["n_plus_one"] == 1 } %>
  <% if n_plus_one_queries.any? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
      <div class="font-semibold text-red-800 text-sm">N+1 Detected</div>
      <div class="text-sm text-red-700 mt-1">
        <%= n_plus_one_queries.size %> N+1 query pattern<%= n_plus_one_queries.size == 1 ? "" : "s" %> found in this request,
        totalling <%= n_plus_one_queries.sum { |q| q["n_plus_one_count"].to_i } %> repeated executions.
      </div>
    </div>
  <% end %>

  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">SQL</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">N+1</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        <% @queries.each do |q| %>
          <tr class="hover:bg-gray-50 <%= q["n_plus_one"] == 1 ? 'bg-red-50' : '' %>">
            <td class="px-4 py-2 text-sm font-mono text-gray-700 max-w-md truncate">
              <a href="<%= tailscope.query_path(q["id"]) %>" class="hover:text-blue-600"><%= truncate_sql(q["sql_text"]) %></a>
            </td>
            <td class="px-4 py-2"><%= duration_badge(q["duration_ms"]) %></td>
            <td class="px-4 py-2"><%= source_link(q["source_file"], q["source_line"]) %></td>
            <td class="px-4 py-2">
              <% if q["n_plus_one"] == 1 %>
                <span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-red-100 text-red-700"><%= q["n_plus_one_count"] %>x</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<% if @errors.any? %>
  <h2 class="text-xl font-bold mt-8 mb-4">Errors (<%= @errors.size %>)</h2>

  <% @errors.each do |error| %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-3">
      <div class="font-semibold text-red-800">
        <a href="<%= tailscope.error_path(error["id"]) %>" class="hover:underline"><%= error["exception_class"] %></a>
      </div>
      <div class="text-sm text-red-700 mt-1"><%= error["message"] %></div>
      <% if error["source_file"] %>
        <div class="text-xs text-gray-500 mt-1"><%= source_link(error["source_file"], error["source_line"]) %></div>
      <% end %>
    </div>
  <% end %>
<% end %>
