<div class="mb-4">
  <a href="<%= debugger_index_path %>" class="text-blue-600 hover:underline text-sm">&larr; Back to Debugger</a>
</div>

<h1 class="text-2xl font-bold mb-4">File Browser</h1>

<div class="mb-4 text-sm text-gray-500 font-mono">
  <%
    parts = @path.sub(@root, "").split("/").reject(&:empty?)
    breadcrumbs = [[@root, @root]]
    parts.each_with_index do |part, i|
      breadcrumbs << [File.join(@root, *parts[0..i]), part]
    end
  %>
  <% breadcrumbs.each_with_index do |(path, label), i| %>
    <% if i > 0 %> / <% end %>
    <a href="<%= debugger_browse_path(path: path) %>" class="text-blue-600 hover:underline"><%= label == @root ? "root" : label %></a>
  <% end %>
</div>

<% if @is_directory %>
  <div class="bg-white shadow rounded overflow-hidden">
    <% if @path != @root %>
    <a href="<%= debugger_browse_path(path: File.dirname(@path)) %>" class="block px-4 py-2 border-b hover:bg-gray-50 text-sm">
      <span class="text-gray-400 mr-2">..</span>
    </a>
    <% end %>

    <% @directories.each do |dir| %>
    <a href="<%= debugger_browse_path(path: File.join(@path, dir)) %>" class="block px-4 py-2 border-b hover:bg-gray-50 text-sm">
      <span class="mr-2 text-yellow-600">&#x1F4C1;</span>
      <span class="font-mono"><%= dir %>/</span>
    </a>
    <% end %>

    <% @files.each do |file| %>
    <a href="<%= debugger_browse_path(path: File.join(@path, file)) %>" class="block px-4 py-2 border-b hover:bg-gray-50 text-sm">
      <span class="mr-2 text-gray-400">&#x1F4C4;</span>
      <span class="font-mono"><%= file %></span>
    </a>
    <% end %>
  </div>
<% else %>
  <div class="bg-gray-900 rounded overflow-hidden">
    <pre class="text-sm"><code><% @lines.each_with_index do |line, i| %>
<% line_num = i + 1 %>
<% has_bp = @breakpoint_lines.include?(line_num) %><span class="<%= has_bp ? 'bg-red-900' : '' %> block px-4 group"><span class="inline-block w-12 text-right mr-2 select-none cursor-pointer text-gray-500 hover:text-red-400 group-hover:text-gray-400" data-line="<%= line_num %>"><% if has_bp %><span class="text-red-500">&#9679;</span><% end %><%= line_num %></span><span class="text-gray-300"><%= h(line.chomp) %></span></span>
<% end %></code></pre>
  </div>

  <script>
  (function() {
    var csrfToken = document.querySelector('meta[name="csrf-token"]');
    var token = csrfToken ? csrfToken.getAttribute("content") : "";

    document.querySelectorAll("[data-line]").forEach(function(el) {
      el.addEventListener("click", function() {
        var line = el.getAttribute("data-line");
        var form = document.createElement("form");
        form.method = "POST";
        form.action = "<%= debugger_breakpoints_path %>";

        var fileInput = document.createElement("input");
        fileInput.type = "hidden";
        fileInput.name = "file";
        fileInput.value = "<%= @path %>";
        form.appendChild(fileInput);

        var lineInput = document.createElement("input");
        lineInput.type = "hidden";
        lineInput.name = "line";
        lineInput.value = line;
        form.appendChild(lineInput);

        var csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "authenticity_token";
        csrfInput.value = token;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
      });
    });
  })();
  </script>
<% end %>
