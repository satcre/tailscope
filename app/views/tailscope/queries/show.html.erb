<div class="mb-4">
  <a href="<%= tailscope.queries_path %>" class="text-sm text-blue-600 hover:underline">&larr; Back to queries</a>
</div>

<h1 class="text-2xl font-bold mb-6">Query #<%= @query["id"] %></h1>

<div class="bg-white rounded-lg shadow p-6 space-y-4">
  <div>
    <div class="text-sm text-gray-500 mb-1">SQL</div>
    <pre class="bg-gray-900 text-green-300 p-4 rounded text-sm overflow-x-auto"><code><%= @query["sql_text"] %></code></pre>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div>
      <div class="text-sm text-gray-500">Duration</div>
      <div><%= duration_badge(@query["duration_ms"]) %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Name</div>
      <div class="text-sm text-gray-900"><%= @query["name"] || "—" %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Request ID</div>
      <div class="text-sm font-mono text-gray-900"><%= @query["request_id"] || "—" %></div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Recorded</div>
      <div class="text-sm text-gray-900"><%= @query["recorded_at"] %></div>
    </div>
  </div>

  <% if @query["n_plus_one"] == 1 %>
    <div class="bg-red-50 border border-red-200 rounded p-3">
      <span class="text-red-700 font-semibold">N+1 Detected</span>
      <span class="text-red-600 text-sm ml-2">This query was executed <%= @query["n_plus_one_count"] %> times in a single request.</span>
    </div>
  <% end %>

  <div>
    <div class="text-sm text-gray-500 mb-1">Source</div>
    <div><%= source_link(@query["source_file"], @query["source_line"]) %></div>
  </div>

  <% if @query["source_file"] %>
    <%= render partial: "tailscope/source/viewer", locals: { file: @query["source_file"], line: @query["source_line"].to_i } %>
  <% end %>
</div>
